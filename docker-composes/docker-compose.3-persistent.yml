services:
  # =====================================================
  # Redis Database Server Service
  # =====================================================
  redis-server:
    image: docker.io/library/redis:7-alpine
    container_name: ${REDIS_SERVER_CONTAINER}
    environment:
      REDIS_ADMIN_USERNAME: ${REDIS_ADMIN_USERNAME}
      REDIS_ADMIN_PASSWORD: ${REDIS_ADMIN_PASSWORD}
      REDIS_USERNAME: ${REDIS_USERNAME}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    ports:
      - "${REDIS_EXTERNAL_PORT}:${REDIS_INTERNAL_PORT}"
    volumes:
      - ../app/initialization/01-create-users.acl:/usr/local/etc/redis/01-create-users.acl
      # Mounting named volume for persistent Redis data storage
      # Volume redis-data will be created automatically on first run
      # Redis is an in-memory database that periodically saves snapshots to disk (RDB files)
      # By default, snapshots are created every 15 minutes OR after 10,000+ write operations
      # All Redis data (RDB snapshots and AOF logs) will be saved in this volume
      - ${REDIS_DATA_PATH}:/data

    # AOF (Append Only File) configuration ensures maximum data durability
    # --appendonly yes creates a separate log file that records every write command immediately
    # This provides ACID-like behavior similar to PostgreSQL - each operation is written to disk
    # On restart, Redis replays all commands from AOF file to restore complete dataset
    # Without AOF, data between snapshots can be lost if container crashes unexpectedly
    # Trade-off: slightly slower performance but much better data safety
    command: redis-server --aclfile /usr/local/etc/redis/01-create-users.acl --appendonly yes

    networks:
      - redis-network
    healthcheck:
      test: ["CMD", "redis-cli", "--user", "${REDIS_ADMIN_USERNAME}", "--pass", "${REDIS_ADMIN_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================================================
  # Redis Client Service
  # =====================================================
  redis-client:
    image: docker.io/library/redis:7-alpine
    container_name: ${REDIS_CLIENT_CONTAINER}
    depends_on:
      redis-server:
        condition: service_healthy
    networks:
      - redis-network
    command: tail -f /dev/null

# =====================================================
# Network Configuration
# =====================================================
networks:
  redis-network:
    driver: bridge

# =====================================================
# Volume Configuration
# =====================================================
volumes:
  redis-data:
    # Using local driver to store data on the host machine
    driver: local
    # Volume will be created in Docker's standard directory (/var/lib/docker/volumes/)
    # Redis data (RDB snapshots and AOF logs) will persist even after container removal
    # On docker-compose restart, data will be restored automatically
